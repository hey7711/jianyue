### PRD: 预约管理 (Appointments)

- PRD ID- PRD-BIZ-2.0
- 功能模块- 预约管理
- 负责人- 小白 (PM)
- 更新日期- 2025年10月20日

#### 背景与目标

- 背景
    - 预约管理是商家日常运营中最高频的核心模块，是连接商家、员工与顾客的中心枢纽。当前，我们的目标用户“亲力亲为的单店老板”大多依赖混乱的纸笔、微信群或Excel进行预约管理，导致效率低下、信息不透明且极易出错。一个直观、高效的数字化预约系统是解决这些痛点的根本，也是我们兑现“增长伙伴”承诺的基础。
- 目标
    - 验证核心业务闭环- 将“顾客在线预约 -> 商家接单服务 -> 完成结算 -> 会员卡券核销”的流程无缝串联起来。
    - 验证组织协作模型- 通过为不同角色（管理员、运营、服务人员）提供差异化的视图和权限，验证我们预设的协作模式能有效支撑真实店铺的日常运营。
    - 提升运营效率- 将所有渠道的预约信息集中到可视化日历中，并自动化状态通知，从而解放商家和员工的时间。
    - 强化增长价值- 提供流畅的卡券核销结算流程，让商家直观感受到会员系统对于锁客和提升复购的价值。

#### 用户故事

- 作为一个商户管理员或运营人员, 我想要在一个可视化的日历上看到所有员工的时间安排, 以便我能对店铺的整体预约情况一目了然，并快速响应顾客的预约需求。
- 作为一个服务人员, 我想要在我的日历上只看到与我个人相关的、并且已经被后台确认的预约, 以便我能清晰地聚焦于我自己的工作任务，避免被不相关的信息干扰。
- 作为一个运营人员, 我想要在收到新预约通知后，能方便地在日历上找到这条待确认的预约，并执行“确认”、“修改”或“取消”操作, 以便高效地管理店铺的预约日程。
- 作为一个商户管理员或运营人员, 我想要在取消一笔预约时，能够记录取消的原因和责任方, 以便未来进行责任追溯和经营分析。
- 作为一个运营人员, 我想要能为通过电话或线下方式咨询的顾客，在日历的空白时段快速手动创建一条预约, 以便将所有渠道的预约都统一到系统中进行管理。
- 作为一个运营人员, 我想要在顾客完成服务后，对日历上的预约进行“结算”操作，并能选择核销顾客的次卡/储值卡，或记录一笔现金收入, 以便完成服务闭环，并确保店铺的账目清晰准确。
- 作为一个运营人员, 在为一位全新的顾客手动创建预约时, 我想要在当前页面就能快速新增一个会员档案, 以便我能在一个流畅、不中断的流程中完成预约创建，而无需跳转到其他页面。
- 作为一个运营人员, 我想要在为一个曾有爽约记录的会员创建新预约时，能看到一个醒目的提醒, 以便我能决定是否需要对本次预约进行二次确认，从而降低店铺的经营风险。

#### 功能范围

- In Scope (本次需求范围)
    - 支持日、周、月视图的预约日历。
    - 区分管理员/运营与服务人员的差异化日历视图。
    - 对线上新预约的“确认”、“修改”、“取消”处理。
    - 手动创建新预约的功能。
    - 预约的结算流程，支持现金和卡券（次卡/储值卡）核销。
    - 标记预约为“未到店”状态。
- Out of Scope (本次需求范围之外)
    - 复杂的循环或周期性预约。
    - 预约金或在线支付功能。
    - 对“已完成”状态的预约进行反向修改或撤销。
    - 混合支付功能 (例如- 使用部分储值卡余额，剩余部分付现金)。
    - 单次预约添加多个服务项目（未来通过“套餐”功能解决）。

#### 流程设计

- 线上预约处理流程
    - 接收新预约通知 -> 在日历找到“待确认”预约 -> 点击确认 -> 顾客到店服务 -> 服务后点击结算 -> 选择支付方式（如核销卡券） -> 完成交易 -> 预约状态变为“已完成”。
- 线下预约处理流程
    - 在日历空白时段点击 -> 填写预约信息（会员、服务、员工等）-> 保存后直接生成“已确认”预约 -> 顾客到店服务 -> 服务后点击结算 -> 选择支付方式（如现金） -> 完成交易 -> 预约状态变为“已完成”。

#### 页面与功能详述

- 页面一- 预约日历 (商户管理员 / 运营人员视图)
    - 页面布局
        - 顶部工具栏-
            - 视图切换- [ 日 ] [ 周 ] [ 月 ]
            - 日期导航- [ < ] [ 当前日期范围 ] [ > ] [ 今天 ]
            - 员工筛选器- 下拉菜单，可多选员工。
            - 主操作按钮- [ + 创建预约 ]
        - 主内容区（以周视图为例）-
            - 多列展示- 时间轴 + 所选员工日程列。
            - 预约卡片- 根据状态（待确认/已确认/已完成）有不同的视觉样式。
    - 功能逻辑
        - 首次加载页面时，系统默认选中并显示前5位员工。当员工总数少于5人时，则全部显示。
        - 当用户通过筛选器选择的员工列总宽度超过屏幕可视区域时，主内容区将出现横向滚动条。
        - 点击日历中的空白时段，会弹出“创建新预约”模态框。
        - 点击已有的预约卡片，会弹出“预约详情”模态框。

- 页面二- 预约日历 (服务人员视图)
    - 页面布局
        - 顶部工具栏（简化）- 视图切换与日期导航。
        - 主内容区- 仅显示当前登录的服务人员自己的日程列。
    - 功能逻辑
        - 日历上只显示状态为“已确认”和“已完成”的、与自己相关的预约。
        - 点击预约卡片可查看详情，但无任何操作按钮。

- 组件三- 预约详情 (模态框)
    - 页面布局
        - 标题- 预约详情
        - 内容- 清晰展示会员、服务项目、预约时间、服务员工、预约备注等信息。
    - 功能逻辑
        - 根据预约状态，底部操作按钮动态显示-
            - 状态为“待确认”时- [ 取消预约 ] [ 修改 ] [ 确认接单 ]
            - 状态为“已确认”时- [ 取消预约 ] [ 修改 ] [ 标记为未到店 ] [ 更换服务人员 ] [ 结算 ]
            - 状态为“已完成”或“未到店”时- 无操作按钮，仅为信息展示。
        - 取消预约流程:
            - 当运营人员点击 `[ 取消预约 ]` 按钮时，系统应在当前模态框之上再弹出一个“确认取消”的迷你模态框。
            - 该模态框需包含一个必填的“取消原因”下拉菜单，选项至少包括：“顾客要求取消”、“商家原因调整”、“其他”。
            - 若选择“其他”，则出现一个选填的文本框供输入具体原因。
            - 点击“确认取消”后，系统将保存取消原因和操作者信息，并将预约单状态更新为“已取消”。            

- 组件四- 手动创建预约 (模态框)
    - 页面布局
        - 标题- 创建新预约
        - 表单区
            - 输入框 (带搜索)-
                - 标签- 会员
                - 占位符- 搜索或选择会员 (支持输入姓名/手机号模糊搜索)
            - 按钮 (文本链接样式)-
                - 文本- [ + 新增会员 ]
            - 下拉菜单-
                - 标签- 服务项目
                - 选项- [ 从已创建的服务列表中选择 ]
            - 下拉菜单-
                - 标签- 服务员工
                - 选项- [ 根据所选服务和时间，动态显示可用的员工 ]
            - 日期选择器-
                - 标签- 预约日期
            - 时间选择器-
                - 标签- 开始时间
            - 多行文本输入框（选填）
                - 标签-  预约备注  
    - 功能逻辑
        - 服务员工的下拉列表，会根据所选服务和时间，动态过滤出有空闲排班的员工。
        - 风险预警: 当运营人员在“会员”字段中选择一个会员后，系统必须即时检查该会员的历史记录。如果该会员存在“未到店”的预约记录，系统应在该输入框旁边或下方显示一个醒目的、不可操作的提示标签，内容为：“[ 曾有爽约记录 ]”。
        - 当运营人员点击 `[ + 新增会员 ]` 按钮时，系统应在当前模态框之上再弹出一个极简的“快速新增会员”模态框，仅包含“姓名”和“手机号”两个必填字段。
        - 在该迷你模态框中保存成功后，新创建的会员信息会自动回填到“创建新预约”表单的“会员”字段中，整个过程无需离开预约日历。
        - 保存后，直接在日历上创建一条状态为“已确认”的预约。

- 页面五- 预约结算
    - 页面布局
        - 顶部为订单信息摘要（会员、服务、应付金额等）。
        - 中部为支付方式选择区，分为“会员卡券”和“其他方式”两大类。
        - 底部为操作按钮。
    - 功能逻辑
        - 系统自动检测并显示会员持有的、可用于抵扣本次服务的卡券。
        - 若卡券余额/次数不足，该选项将被禁用并提示原因。
        - 选择“现金”等方式时，允许运营人员修改“实收金额”。
        - 点击`[ 确认收款 ]`后，系统需严格遵循下文“订单（交易单）业务逻辑”中定义的核心流程。
        - MVP版本限制: 当前版本的结算流程仅支持选择一种支付方式完成全额支付，不支持组合支付。

#### 核心业务规则

- 信息流转与权限规则
    - 新的线上预约提交后，系统仅通知商户管理员和运营人员。
    - 只有商户管理员和运营人员有权限确认、修改或取消预约。
    - 当预约被取消时，系统必须记录操作者（取消方）以及选择的取消原因，用于后续的运营追溯与分析。
    - 一条预约只有在被确认为“已确认”状态后，才会出现在对应服务人员的个人日历中。
    - 当更换服务人员操作成功后，系统必须同时向原服务人员、新服务人员和顾客三方发送微信通知，告知他们这一变更。

- 预约冲突检测规则
    - 创建时并发控制: 系统必须有并发锁定机制。若两个操作员同时为同一员工的同一时间段创建预约，后提交的请求将被拒绝，并提示“该时段已被预定，请刷新后重试。”。
    - 修改时冲突检测: 当用户修改一个已存在的预约（包括修改开始时间、或因更换服务项目导致时长变化）时，系统必须对该预约的完整新时间段（新的开始时间至新的结束时间）进行可用性校验。如果该时间段与该服务人员的其他任何预约或排班休息时间有重叠，操作将被禁止，并提示用户“该时间段存在冲突，请重新选择。”

- 并发控制规则
    - 系统必须有并发锁定机制。若两个操作员同时为同一员工的同一时间段创建预约，后提交的请求将被拒绝，并提示“该时段已被预定，请刷新后重试。”

- 订单（交易单）业务逻辑
    - 核心定位: `交易单`是系统的财务记账凭证，旨在不可篡改地记录每一笔价值交换，以解决商家“财务混乱”的痛点。
    - 创建触发器:
        - 结算预约: 当`预约单`服务完成并结算时，创建`交易类型`为“服务消费”的`交易单`。
        - 直接售卡: 在会员详情页办理或充值卡券时，创建`交易类型`为“卡券购买”或“卡券充值”的`交易单`。
    - 预约结算流程详解:
        - 运营人员对`预约单`发起结算，选择一种`支付方式`（如次卡、储值卡、现金等）。
        - 确认收款后，系统必须执行原子操作（全部成功或全部失败）-
            - 创建`交易单`: 记录本次交易的金额、方式、关联的`预约单ID`等。
            - （若使用卡券）创建`卡券流水`: 记录一笔“消费”流水，并更新对应`卡券实例`的剩余次数/余额。
            - 更新`预约单`: 将`预约单`的状态更新为“已完成”。
    - 财务完整性规则:
        - 不可变性: `交易单`一旦创建，即代表一个已发生的财务事实，不允许任何角色直接修改或删除。
        - 错误修正: MVP阶段不提供线上反向操作（如退款）。错误结算需由商户管理员进行线下记录，或联系客服后台冲正。未来的“退款”功能将通过创建一笔负金额的`交易单`来实现，以保证账目的可追溯性。
    - 数据一致性与快照规则
        - 服务项目的任何属性变更（包括价格和时长），将不会影响任何已经创建的预约单。
        - 规则详解: 预约单在创建时，即已将当时的服务价格与时长等关键信息进行“快照”式存储。后续对服务项目的修改，仅对变更后新创建的预约生效，以确保历史和未来已定预约的财务和时间安排不受影响。

#### 成功指标

- 核心业务闭环验证
    - 卡券核销率- (通过核销卡券完成的结算笔数 / 所有结算总笔数) > 30%，表明会员增长引擎被有效使用。
- 运营效率提升
    - 线上预约占比- (线上预约数 / 总预约数) 持续提升。
    - 新预约平均处理时长- 从收到通知到完成“确认接单”操作的平均时间 < 5分钟。
- 用户采纳度
    - 日活跃用户（DAU）- 运营人员角色的日活比例 > 80%。
