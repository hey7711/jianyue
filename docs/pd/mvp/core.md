### PRD-CORE: 系统核心与通用能力

- PRD ID: PRD-CORE-MVP-1.0
- 功能模块: 系统核心与通用能力
- 目标: 定义系统的基础规则、数据模型和共享服务，作为所有其他 PRD 的基石。

#### 统一用户与账户模型 (Account Model)

- 说明

  - 这是系统组织关系的基础，明确了“谁可以登录”和“数据的归属”。本模型的核心设计思想是：`商家`是一个组织实体（租户），它本身不能登录；实际登录系统进行操作的是隶属于商家的`员工`账户。`会员`是商家的客户资产，归属于特定商家。而`平台员工`是运营我们整个 SaaS 平台的内部管理者，独立于所有商家之外。

- 核心实体定义

  - 商家 (Merchant)

    - 定义: 系统的核心组织单位和付费主体，是`员工`、`会员`、服务项目等所有业务数据的顶层所有者（即“租户”）。`商家`是一个组织实体，本身不作为可登录的账户。
    - 关键属性: 商家 ID，店铺信息引用，订阅状态。

  - 员工 (Team Member)

    - 定义: 隶属于某个`商家`的、可登录的操作账户。商家所有者（老板）是第一个被创建的`员工`，并被授予“商户管理员”角色。随后，他可以创建更多的`员工`账户（如前台、技师）并分配不同角色。
    - 关键属性: 员工 ID，姓名，手机号，密码，所属商家 ID，角色引用，微信 OpenID (绑定后)。

  - 会员 (Customer / Member)

    - 定义与关系:
      - 这是`商家`的服务对象，也是其最重要的私域客户资产。
      - 在系统后台，我们统一称之为`会员`，以强调其作为可长期管理的数字资产的价值。在顾客端小程序中，为了体验更自然，可称之为“用户”或“您”。
      - 系统的核心机制是将服务过的顾客自动沉淀为`会员`。当一个新顾客通过小程序首次成功提交预约后，系统会自动在商家后台的“会员”模块为他创建一个会员档案。
    - 关键属性: 会员 ID，微信昵称，微信 OpenID，手机号 (可选)，所属商家 ID。

  - 平台员工 (Internal User)
    - 定义: 运营“简约”SaaS 平台的内部团队账户（如运营、客服），使用`管理端`来管理所有`商家`。此账户独立于任何`商家`体系之外，拥有平台级的全局管理权限。
    - 关键属性: 平台员工 ID，姓名，手机号，密码，平台角色（例如：超级管理员、运营、客服）。

- 登录认证体系
  - 员工登录
    - 首次登录: 商户管理员在后台创建员工账号后，员工使用收到的手机号和临时密码进行首次登录。
    - 微信绑定: 首次登录后，系统会强制引导员工扫码，将其系统账户与个人微信进行绑定。
    - 便捷登录: 绑定成功后，员工即可通过微信扫码或在微信内免密访问商户端。
  - 顾客登录
    - 登录方式: 顾客访问小程序时，系统通过静默或主动引导的方式获取其微信授权，后台基于微信 OpenID 自动创建或识别其顾客身份，实现无感登录。
  - 认证机制
    - 技术原则: 采用基于 Token 的认证机制。用户成功登录后，后端签发有时效性的 Token，前端在后续请求的 Header 中携带此 Token 进行身份验证。同时应包含 Token 刷新机制以维持登录状态。

#### 角色与权限体系 (RBAC)

- 策略说明

  - 基于我们的核心策略——服务“亲力-亲为的单店老板”并提供“极致易用”的产品体验，MVP 阶段我们采用内置固定的三角色体系，不支持商家自定义。这套体系直接映射了小型单店最典型的组织协作模型，旨在让商家“开箱即用”，无需进行复杂的权限配置，从而降低其使用门槛和认知负荷。

- 角色定义

  - 商户管理员 (Administrator)
    - 定义: 店铺的所有者或最高管理者，通常对应我们的核心用户画像“亲力亲为的单店老板”。他们为店铺的最终经营结果负责，因此拥有系统内的所有权限。
  - 运营人员 (Operator)
    - 定义: 店铺的前台、店长或负责日常运转的员工，对应用户画像“任务导向的前台/客服”。他们是系统的最高频使用者，负责处理绝大多数日常操作，如预约管理和会员接待。
  - 服务人员 (Practitioner)
    - 定义: 店铺的一线服务提供者，如技师、发型师、教练等，对应用户画像“专注服务的从业人员”。其权限被严格限制在仅查看与自身服务相关的必要信息，以保证数据安全和信息简洁，避免无关信息的干扰。

- 权限边界定义

  - 预约 (Appointments)
    - 商户管理员: 增、删、改、查所有团队成员的预约。
    - 运营人员: 增、删、改、查所有团队成员的预约。
    - 服务人员: 仅可查看与自己相关的、且状态为“已确认”的预约。
  - 服务项目 (Services)
    - 商户管理员: 增、删、改、查。
    - 运营人员: 查。
    - 服务人员: 查。
  - 团队成员与排班 (Team & Shifts)
    - 商户管理员: 增、删、改、查所有团队成员的账号及排班。
    - 运营人员: 查看所有团队成员，管理所有人的排班。
    - 服务人员: 仅可查看自己的排班。
  - 作品 (Portfolio)
    - 商户管理员: 增、删、改、查所有团队成员的作品。
    - 运营人员: 查。
    - 服务人员: 仅可增、删、改、查自己的作品。
  - 会员 (Members)
    - 商户管理员: 增、删、改、查。
    - 运营人员: 增、改、查。
    - 服务人员:
      - 仅可查看与自己相关的会员。
      - “相关”的定义为：由该服务人员提供过历史服务，或在未来有已确认预约的会员。
  - 增长 (Growth - 卡券模板)
    - 商户管理员: 增、删、改、查卡券模板。
    - 运营人员: 查。
    - 服务人员: 无权限。
  - 财务 (Finance - 交易单与卡券流水)
    - 商户管理员: 增、删、改、查所有财务记录。
    - 运营人员: 增、查（为会员办理业务或结算时创建记录，并可查看历史记录）。
    - 服务人员: 无权限。
  - 统计 (Analytics)
    - 商户管理员: 查。
    - 运营人员: 查。
    - 服务人员: 无权限。
  - 设置 (Settings)
    - 商户管理员: 拥有所有设置项的全部权限。
    - 运营人员: 无权限。
    - 服务人员: 无权限。
  - 个人设置 (Personal Settings)
    - 所有角色: 均可修改自己的个人资料、密码，并管理个人微信绑定。

- 技术实现原则
  - 商户端与员工端在技术上为同一个应用，需根据登录员工的角色动态渲染界面和功能权限。
  - 后端应在 API 层面设计一个统一的权限校验中间件。该中间件通过解析请求者的 Token 获取其员工 ID 和角色，再根据预设的权限规则列表判断其是否有权访问目标 API，实现集中、可靠的权限控制。

---

#### 核心业务数据模型 (Business Entities)

- 说明

  - 以下定义了支撑“简约”SaaS 平台核心业务运转的数据结构。这些模型是系统功能的基石，明确了各个业务对象的属性和约束。

- 核心实体

  - 订阅计划 (Subscription Plan)

    - 定义: 定义了商家可以订阅的、包含不同功能和资源限制的服务套餐。
    - 关键字段: 计划 ID, 计划名称, 价格, 计费周期, 团队成员数量限制, 月订单量限制。

  - 商家 (Merchant)

    - 定义: 系统的组织租户和付费主体，是所有业务数据的顶层容器。
    - 关键字段: 商家 ID, 订阅计划 ID, 服务到期日。

  - 店铺 (Shop)

    - 定义: `商家`对外提供服务的具体经营场所，同时承载了该店铺的个性化业务规则配置。
    - 关键字段: 店铺 ID, 所属商家 ID, 店铺名称, Logo, 联系方式, 预约设置, 自定义称谓。
    - 关系: MVP 阶段，一个`商家`仅关联一个`店铺`。

  - 团队成员 (Team Member)

    - 定义: 隶属于`商家`的可登录操作账户。
    - 关键字段: 成员 ID, 所属商家 ID, 姓名, 手机号, 密码, 角色, 微信 OpenID。

  - 排班 (Schedule)

    - 定义: 存储`团队成员`可用工作时间的核心模型，是系统计算顾客端可预约时间段的直接依据。
    - 关键字段: 班次 ID, 所属团队成员 ID, 类型 (固定班次/临时请假), 开始时间, 结束时间, 重复规则。

  - 顾客 (Customer)

    - 定义: 用户在小程序端的数字身份，主要用于登录认证和消息触达。
    - 关键字段: 顾客 ID, 微信 OpenID, 微信昵称, 头像。

  - 会员 (Member)

    - 定义: `商家`的客户关系管理（CRM）资产，是所有核心业务的操作主体。
    - 关键字段: 会员 ID, 所属商家 ID, 姓名, 手机号, 关联顾客 ID (可为空)。

  - 服务项目 (Service)
    - 定义: `商家`提供给`会员`的具体服务产品，包含其完整定义和规则。
    - 关键字段:
      - 项目 ID
      - 所属店铺 ID
      - 项目名称 (`name` - 字符串)
      - 服务价格 (`price` - 金额)
      - 服务时长 (`duration` - 分钟, 核心服务时间)
      - 服务前准备时间 (`buffer_before` - 分钟, 可选)
      - 服务后清理时间 (`buffer_after` - 分钟, 可选)
      - 服务介绍 (`description` - 文本类型, 可选)
      - 允许顾客在线预约 (`online_booking_enabled` - 布尔值)
      - 状态 (`status` - 例如：启用 Enabled / 已停用 Disabled)
      - 排序 (`sort_order` - 整数, 用于手动排序)
    - 关联关系:
      - 可提供此服务的员工: 与 `团队成员 (Team Member)` 的多对多关联关系 (需要关联表或类似机制存储 `assignable_staff_ids`)。
  - 服务人员档案 (ServiceProviderProfile)
    - 定义: 存储那些实际提供预约服务（无论其系统角色是管理员还是服务人员）的团队成员的补充信息，主要用于顾客端小程序展示，提升顾客选择体验并允许商家控制展示顺序。
    - 关键字段:
      - `档案ID (profile_id)`: 主键。
      - `团队成员ID (team_member_id)`: 外键，唯一关联到 `团队成员 (Team Member)` 模型，表明此档案属于哪个系统账户。
      - `头像URL (avatar_url)`: (可选, 字符串) 专业头像的链接。若为空，系统可尝试使用关联 `Team Member` 的微信头像作为备选。
      - `昵称/称呼 (nickname)`: (可选, 字符串) 面向顾客展示的称呼。若为空，系统默认使用关联 `Team Member` 的 `姓名 (name)` 字段。
      - `性别 (gender)`: (可选, 枚举/字符串) 例如：男 / 女 / 未指定。用于顾客端筛选或参考。
      - `职称/头衔 (title)`: (可选, 字符串) 例如：“高级发型师”、“首席美容顾问”、“金牌教练”。
      - `工作年限 (years_of_experience)`: (可选, 整数) 例如：5, 10。
      - `个人简介 (bio)`: (可选, 文本类型) 一段描述性文字，介绍服务人员的经验、风格、理念等。
      - `擅长项目 (specialties)`: (可选, 文本类型) 简述服务人员擅长的领域或具体项目（MVP 阶段为纯文本）。
      - `排序值 (sort_order)`: (整数, 默认为 0 或一个较大的数) 控制该服务人员在顾客端选择列表中的展示顺序，数值越小越靠前。
    - 关联作品集: 该档案对应的作品集信息，通过关联的 `团队成员ID` 查询 `作品 (PortfolioItem)` 模型获得 (一对多关系)。作品集的管理功能不在 MVP 范围。
  - 作品 (PortfolioItem)

    - 定义: `团队成员`可上传和展示的个人作品集，以满足美发等核心目标行业的特定需求。
    - 关键字段: 作品 ID, 所属团队成员 ID, 图片/视频链接, 作品描述, 关联服务项目 ID (可选)。

  - 预约单 (Appointment)

    - 定义: 连接`会员`、`服务项目`和`团队成员`的核心业务单据。
    - 关键字段: 预约 ID, 所属店铺 ID, 关联会员 ID, 关联服务项目 ID, 关联团队成员 ID, 预约时间, 状态。

  - 交易单 (Transaction)

    - 定义: 记录商家所有收入的核心财务模型，是解决“财务混乱”痛点 和支撑`统计`模块 的基础。
    - 关键字段: 交易 ID, 所属店铺 ID, 关联会员 ID, 交易类型 (服务消费/卡券购买), 交易金额, 支付方式, 关联预约单 ID (可选), 操作团队成员 ID。

  - 卡券模板 (CardTemplate)

    - 定义: 由`商家`预设的可售卖的卡券产品类型。
    - 关键字段: 模板 ID, 所属店铺 ID, 名称, 类型 (次卡/储值卡), 售价, 有效期规则, (次卡)包含次数 / (储值卡)面额与赠送金额。

  - 卡券实例 (CardInstance)

    - 定义: `会员`实际持有的具体卡券资产。
    - 关键字段: 实例 ID, 关联卡券模板 ID, 所属会员 ID, 剩余次数或余额, 过期时间。

  - 卡券流水 (LedgerEntry)

    - 定义: 追踪`卡券实例`余额或次数变化的明细账本，是解决“客户耗卡”计算混乱痛点的关键。
    - 关键字段: 流水 ID, 所属卡券实例 ID, 变动类型 (购买/消费/过期), 变动前/后余额, 变动值, 关联交易单 ID。

  - 短信账户 (SMSAccount)

    - 定义: 用于管理和追踪商家购买的“短信通知包”这一增值服务的余量。
    - 关键字段: 账户 ID, 所属商家 ID, 短信总购买量, 短信剩余量。

  - 平台员工 (Internal User)
    - 定义: 运营“简约”SaaS 平台的内部团队账户，使用`管理端`来管理所有`商家`。
    - 关键字段: 平台员工 ID, 姓名, 手机号, 密码, 平台角色。

#### 通知服务 (Notification Service)

- 策略说明
  - 通知服务是“简约”产品的“神经系统”，旨在确保在关键业务节点上，信息能够及时、准确地在商家、团队成员和顾客之间流转。我们的核心策略是深度拥抱微信生态，以微信服务通知作为主要触达渠道，因为它体验最原生、触达率最高，最符合我们“微信原生一体化体验”的价值主张。短信将作为补充渠道，用于特定场景（如新员工账户激活）或作为付费增值服务。

##### 面向商家 / 团队成员的通知

- 新预约提交通知

  - 触发场景: 顾客在小程序端成功提交一个新的预约。
  - 接收对象: 商户管理员、运营人员。
  - 渠道: 微信服务通知。
  - 业务目的: 确保运营团队能第一时间获知新订单，并及时在后台进行`[ 确认接单 ]`操作，避免错单、漏单。

- 顾客自助取消预约通知

  - 触发场景: 顾客在小程序端自助取消了一个“待服务”的预约。
  - 接收对象: 商户管理员、运营人员、该预约的原定服务人员。
  - 渠道: 微信服务通知。
  - 业务目的: 及时释放被占用的服务资源，避免因信息不畅导致的时间和收入损失。

- 服务人员变更通知 (对内)

  - 触发场景: 运营人员在后台对一个已确认的预约执行了`[ 更换服务人员 ]`操作。
  - 接收对象: 该预约的原服务人员和新服务人员。
  - 渠道: 微信服务通知。
  - 业务目的: 确保团队内部信息实时同步。原服务人员知道自己的时间已被释放，新服务人员知道自己有新的任务安排。

- 新会员自动注册提醒

  - 触发场景: 新顾客首次预约成功，系统自动为其在后台创建了会员档案。
  - 接收对象: 商户管理员、运营人员。
  - 渠道: 微信服务通知。
  - 业务目的: 强化“增长伙伴”的价值感知，激励商家主动与新会员建立联系，进行客户关系维护。

- 新团队成员账户创建通知
  - 触发场景: 商户管理员在后台成功创建了一个新的团队成员账号。
  - 接收对象: 新创建的团队成员。
  - 渠道: 短信 (因为新成员此时尚未绑定微信)。
  - 业务目的: 发送初始登录凭证（如手机号、临时密码、登录链接），确保新员工能顺利完成首次登录和微信绑定，是 Onboarding 流程的起点。

##### 面向顾客 / 会员的通知

- 预约已确认通知

  - 触发场景: 商家在后台对一个“待确认”的预约点击了`[ 确认接单 ]`。
  - 接收对象: 提交该预约的顾客。
  - 渠道: 微信服务通知。
  - 业务目的: 给予顾客一个确定的反馈，让其可以安心地按计划前来，是建立信任的第一步。

- 预约变更或取消通知

  - 触发场景: 商家在后台对一个“已确认”的预约执行了`[ 修改 ]`或`[ 取消 ]`操作。
  - 接收对象: 该预约的顾客。
  - 渠道: 微信服务通知。
  - 业务目的: 保障顾客的知情权，避免顾客因信息不畅而白跑一趟，维持商家的专业形象。

- 服务人员变更通知 (对外)

  - 触发场景: 运营人员在后台对一个已确认的预约执行了`[ 更换服务人员 ]`操作。
  - 接收对象: 该预约的顾客。
  - 渠道: 微信服务通知。
  - 业务目的: 同样是保障顾客的知情权，尤其是在顾客指定了特定服务人员的场景下，这是至关重要的尊重和沟通。

- 手动创建预约成功通知

  - 触发场景: 运营人员通过线下沟通（如电话）后，在后台为顾客手动创建了一个预约。
  - 接收对象: 该预约关联的会员（需已绑定微信）。
  - 渠道: 微信服务通知。
  - 业务目的: 将线下预约流程线上化、凭证化，为顾客提供一个正式的、可随时查阅的预约凭证，提升服务的专业度和信任感。

- 卡券办理/充值成功通知
  - 触发场景: 运营人员在后台为会员成功办理了新卡或完成了充值。
  - 接收对象: 该会员。
  - 渠道: 微信服务通知。
  - 业务目的: 这是一个关键的交易凭证。及时、透明地告知用户资产变更，是建立和维护预付费业务信任的基石，能有效避免财务纠纷。

##### 面向商户管理员的系统级通知

- 订阅服务到期前提醒

  - 触发场景: 商家的“专业版”等付费订阅服务即将到期（如提前 7 天）。
  - 接收对象: 商户管理员。
  - 渠道: 微信服务通知。
  - 业务目的: 主动提醒商家续费，防止因遗忘导致服务中断，是 SaaS 业务中提升续费率、降低流失率的关键运营手段。

- 订阅服务已到期/已降级通知

  - 触发场景: 商家付费订阅到期，系统自动将其账号降级为“体验版”。
  - 接收对象: 商户管理员。
  - 渠道: 微信服务通知。
  - 业务目的: 明确告知商家其账户状态已变更及受到的功能限制，创造续费的紧迫感。

- 技术对接逻辑
  - 系统需设计统一的通知服务模块。当业务逻辑触发上述任一事件时，应调用此模块的统一接口。该接口负责根据事件类型和接收方，组装符合微信或短信网关要求的消息体，并调用相应 API 进行下发。顾客端需在关键操作（如提交预约）后引导用户订阅一次性消息，以确保通知能够成功送达。

#### 订阅与版本管理 (Subscription Model)

- 策略说明

  - 我们采用“免费体验 + 付费升级”的 Freemium 模式。其核心商业逻辑是：通过免费的`体验版`，让商家无风险地感受我们产品在“效率提升”上的价值；然后，通过`专业版`独有的“增长引擎”，来驱动那些严肃对待生意的商家付费，将软件开销转变为一笔高回报的生意投资。

- 版本定义与差异

  - 体验版 (免费)

    - 目标: 核心是“效率工具”，旨在让新商家无门槛地体验到在线预约和数字化排班带来的效率提升。
    - 核心能力:
      - 包含完整的在线预约流程管理。
      - 包含基础的团队与排班管理。
      - 包含基础的会员信息录入。
    - 核心限制:
      - 团队成员数量限制（例如：3 人以内）。
      - 每月预约订单量限制（例如：100 单/月）。
      - 无法使用任何“增长”模块的功能，特别是无法创建和售卖卡券。

  - 专业版 (付费)

    - 目标: 核心是“增长伙伴”，专为希望提升复购、锁住客户、增加收入的严肃商家设计。
    - 核心价值: 在`体验版`所有效率功能的基础上，解锁三大核心增长引擎：
      - 无限制的核心运营能力:
        - 解除团队成员数量和月预约订单量的所有限制，让商家的业务规模不受束缚。
      - 完整的会员增长引擎:
        - 这是专业版最核心的价值。商家将可以创建、售卖并管理“次卡”和“储值卡”。这不仅是提升顾客锁客率与复购率的关键工具，更是帮助商家改善现金流的强大引擎。
      - 深度的经营数据分析:
        - 商家将获得完整的`统计`模块访问权限，可以通过“今日”、“本周”、“本月”等多个维度，清晰地洞察营业额、订单数等核心经营指标，从而做出数据驱动的决策。

  - 旗舰版 / 连锁版 (未来规划)
    - 目标: 面向未来的连锁品牌或有更复杂需求的商家，是产品成熟后的战略拓展方向。
    - 核心功能: 在`专业版`基础上，增加多门店管理、跨店会员与结算、精细化员工权限、高级数据报表等功能。

- 增值服务 (可选付费项)

  - 短信通知包: 作为微信服务通知的补充，为有强需求的用户提供付费的短信提醒服务。
  - 一对一专家陪跑服务: 提供更高阶的运营指导和系统配置服务，帮助商家更好地利用系统实现增长。

- 订阅状态与规则

  - 初始状态: 由内部团队在管理后台手动创建的商家账号，默认为“体验版”。
  - 到期规则:
    - 到期前提醒: “专业版”等付费服务到期前 7 天，系统将通过应用内提示及微信服务通知提醒商户管理员。
    - 到期后处理: 付费服务到期后，账号将自动降级为“体验版”。超出“体验版”限制的数据将被冻结（例如，若有 5 名团队成员，则只有前 3 名可被正常使用），但数据不会被删除，以便商家续费后能无缝恢复。
