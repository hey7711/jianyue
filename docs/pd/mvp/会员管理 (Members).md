### PRD: 会员管理 (Members)

-   PRD ID- PRD-BIZ-4.0
-   功能模块- 会员管理
-   负责人- 小白 (PM)
-   更新日期- 2025年10月21日

#### 背景与目标

-   背景
    -   会员是商家最宝贵的私域资产。一个强大的会员管理系统是商家摆脱客户流失、实现精细化运营和持续增长的基础。本模块旨在将分散的客户信息统一沉淀为商家的数字资产，并提供管理和激活这些资产的核心工具。
-   目标
    - 资产沉淀: 提供手动录入和批量导入工具，帮助商家将线下存量客户和线上新客统一管理起来，解决“客户资产流失”痛点。
    - 客户洞察: 通过360度会员详情视图，聚合会员的关键信息（基础资料、卡券、消费、预约、爽约记录），赋能商家进行客户分析和个性化服务。
    - 增长引擎落地: 提供为会员办理和充值卡券的核心功能，支撑“次卡/储值卡”这一MVP阶段的关键增长价值主张。
    - 数据迁移: 解决商家在启用新系统时“数据迁移是最大障碍”的核心痛点，提供批量导入功能降低上手门槛。

#### 用户故事

-   作为一个运营人员, 我想要能通过姓名或手机号快速搜索会员, 以便当顾客到店或来电时，我能迅速定位到他们的档案。
-   作为一个运营人员, 即使我的店铺会员数量非常多，我也想要能流畅地浏览会员列表，并能快速跳转到指定页面, 以便高效地进行日常管理工作。
-   作为一个运营人员, 我想要能方便地手动录入一个线下新顾客的信息（姓名、手机号、备注）, 以便将他们的信息沉淀到系统中，开始进行数字化管理。
-   作为一个运营人员, 我想要能方便地修改一个会员的基础信息（如姓名、手机号或备注）, 以便在录入错误或信息变更时能及时修正。
-   作为一个运营人员, 我想要能清晰地分辨出哪些会员是“手动录入”的，哪些是“线上自动注册”的, 以便我了解他们的来源。
-   作为一个商户管理员或运营人员, 我想要在一个页面上查看到一个会员的360度完整视图, 包括他们所有的历史预约、消费记录、未到店情况以及持有的、状态清晰的卡券（包含有效期），以便我能全面了解客户，为他们提供个性化的服务。
-   作为一个商户管理员或运营人员, 我想要在查看会员的历史消费记录时，能清晰地看到每一笔消费是用哪一张具体的卡券支付的, 以便在核对账目或处理顾客疑问时，能快速追溯资金流水。
-   作为一个商户管理员或运营人员, 我想要在会员详情页清楚地看到该会员的历史爽约（未到店）次数, 以便我能准确评估其信用风险。
-   作为一个商户管理员或运营人员, 我想要能在会员的详情页面里，方便地为他们办理一张新的次卡或储值卡，并记录下我实际收到的金额, 以便锁定客户的未来消费，提升店铺的现金流。
-   作为一个商户管理员或运营人员, 我想要能在会员的详情页面里，为他们已有的储值卡方便地“充值”更多金额, 以便处理顾客的续费需求。
-   作为一个商户管理员, 我想要能通过Excel模板，一次性批量导入我的存量老会员名单（姓名、手机号、备注）, 以便我能快速完成数据迁移，而不是逐个手动录入。
-   作为一个商户管理员, 我想要能“归档”一个不再活跃或重复的会员, 以便在不删除他们历史消费记录的前提下，保持我的会员列表干净、整洁。
-   作为一个商户管理员, 我想要能方便地找到并“恢复”一个被误归档的会员, 并且在恢复时如果遇到手机号冲突，系统能明确告知我并引导我解决, 以便能快速纠正操作失误或处理数据冲突。
-   作为一个运营人员, 我想要在会员列表中就能快速看到哪些会员有备注信息, 以便我能优先关注那些有特殊需求或情况的顾客。
-   作为一个商户管理员或运营人员, 当发现一个会员错误地关联了某个微信身份时, 我想要能手动解除这个绑定关系, 以便纠正数据错误，保护用户隐私。
-   作为一个商户管理员或运营人员, 当会员对某张卡券的余额或次数变化有疑问时, 我想要能在会员详情页直接点击该卡券，快速查看只与这张卡相关的所有充值和消费明细, 以便高效地解答客户疑问。
-   作为一个商户管理员, 当我提交批量导入任务后，我想要在任务完成后收到明确的通知，并且能方便地随时找到并下载导入结果报告, 以便我了解导入情况并处理失败的数据。


#### 功能范围

-   In Scope (本次需求范围)
    - 增（手动录入、批量导入）、删（归档）、改、查会员档案。
    - 会员列表支持按姓名/手机号搜索，支持按“活跃/已归档”状态筛选。
    - 查看会员360度详情，包括基础信息、备注、关键指标（含未到店次数）、持有卡券、历史预约与消费记录。
    - 为会员办理新的次卡或储值卡。
    - 为会员已有的储值卡进行充值。
    - 手动解除会员与微信身份（顾客）的绑定关系。
    - 恢复已归档的会员。
-   Out of Scope (本次需求范围之外)
    - 商家自定义会员标签的创建、管理与应用。
    - 会员等级与积分体系。
    - 精细化的会员筛选与分组功能。
    - 直接物理删除会员档案。
    - 手动为会员指定或绑定一个微信身份（顾客）。
    - 合并重复的会员档案功能 (考虑到其业务逻辑复杂性，此功能将在未来版本中规划)。

#### 流程设计

-   核心流程
    - 新会员录入: 手动录入 / 批量导入 / 线上预约自动建档。
    - 会员查询: 列表浏览 / 关键词搜索。
    - 会员维护: 编辑基础信息 / 归档 / 恢复。
    - 价值管理: 查看会员详情 -> 办理新卡 / 为旧卡充值。

#### 页面与功能详述

-   页面一- 会员管理 (主页面)
    -   页面布局
        - 顶部工具栏- 搜索框, 视图筛选器 ([活跃会员]/[已归档会员]), 主操作按钮 ([+ 手动录入]), 更多操作按钮 ([...]->[批量导入会员])。
        - 内容区 (会员列表)-
            - 表头- [ 姓名 ] [ 手机号 ] [ 标签 ] [ 历史消费 ] [ 备注指示 ] [ 操作 ] (新增备注指示列)
            - 列表行 (示例1 - 有备注)-
                - 姓名- 王先生
                - 手机号- 1381234
                - 标签- —
                - 历史消费- ¥ 880.00
                - 备注指示- [ 备注图标 ] (例如一个小文档或便签图标)
                - 操作- [ ... ]
            - 列表行 (示例2 - 无备注)-
                - 姓名- 李女士
                - 手机号- 1395678
                - 标签- [ 微信注册 ]
                - 历史消费- ¥ 0.00
                - 备注指示- — (留空或显示占位符)
                - 操作- [ ... ]
        - 列表底部:
            - 分页控件 (例如：显示“共 153 条记录”，页码列表 [1] [2] [3] ... [8]， 前往 [输入框] 页)        
    -   功能逻辑
        - 列表展示
            - 默认显示“活跃会员”。“线上注册”的会员姓名旁显示微信图标，手机号为空时显示“(待补充)”。“标签”列目前仅用于展示系统标签（如“微信注册”）。
            - 备注指示: 如果一个会员的档案中存在非空的备注信息，则在“备注指示”列显示一个清晰的图标。鼠标悬停在该图标上时，可以Tooltip形式预览备注内容的前N个字（例如前30字）。
            - 历史消费: 此列显示该会员自加入系统以来，所有已完成的交易单中记录的累计消费金额。包括现金支付和服务项目对应的卡券核销价值（具体核销价值计算规则需后续明确，MVP可先按服务项目售价计算）。不包括卡券购买或充值的金额。
        - 列表加载与分页:
            - 页面首次加载或执行搜索/筛选操作后，默认加载第一页数据（例如，每页显示20条）。
            - 用户可以通过点击页码、上一页/下一页按钮或直接输入页码跳转来浏览不同的数据页。
            - 分页控件需清晰显示总记录数和当前页码。        
        - 搜索: 支持按姓名、手机号模糊搜索。
        - 筛选: 可切换查看“已归档会员”列表。
        - 操作列:
            - 活跃会员：[ 查看详情 ] [ 编辑 ] [ 归档 ]。
            - 已归档会员：[ 编辑 ] [ 恢复 ]。(新增编辑入口)
        - 恢复流程:
            - 当管理员点击 `[ 恢复 ]` 时，系统必须先校验该已归档会员的手机号是否与当前任何活跃会员的手机号冲突。
            - 若无冲突: 系统弹出一个确认框：“您确定要恢复会员‘张三’吗？” 确认后，该会员的状态恢复为“活跃”，并从“已归档”列表移回“活跃会员”列表。
            - 若存在冲突: 系统阻止恢复操作，并弹出一个提示框，内容为：“恢复失败。该会员的手机号 1381234 已被另一位活跃会员使用。请先修改冲突会员的手机号，或编辑此已归档会员的手机号后再尝试恢复。” (引导用户使用新增的编辑功能解决冲突)

-   页面二- 会员详情
    -   页面布局
        - 区域一：概览 (姓名、标签、[办理新卡]按钮)。
        - 区域二：关键指标 (累计消费、卡券余额、未到店次数 - 此项需高亮)。
        - 区域三：基础信息
            - 标题- 基础信息 [ 编辑 ]
            - 手机号：1381234 (或 "(待补充)")
            - 来源：微信小程序 (或 "手动录入")
            - 注册时间：2025年10月20日
            - 备注：(显示备注内容)
            - 微信绑定: (仅当会员已关联顾客时显示)
                - 标签- 已绑定微信：
                - 值- [微信头像] 微信昵称
                - 操作链接- `[ 解除绑定 ]`
        - 区域四：持有卡券
            标题- 持有卡券 (共 2 张)
            卡券卡片1 (储值卡 - 有效)
                卡券名称- 充1000送200储值卡
                余额- ¥ 1,700.00
                有效期至- 2026年10月20日
                状态- [ 有效 ] (绿色标签)
                操作按钮- [ 充值 ]
                查看流水链接- [ 查看明细 ]
            卡券卡片2 (次卡 - 已用尽)
                卡券名称- 经典剪发次卡 (10次)
                剩余- 0 次
                有效期至- 2025年12月31日
                状态- [ 已用尽 ] (灰色标签)
                查看流水链接- [ 查看明细 ]
                (无操作按钮)
            卡券卡片3 (次卡 - 已过期)
                卡券名称- 体验次卡 (3次)
                剩余- 1 次
                有效期至- 2025年09月30日
                状态- [ 已过期 ] (灰色标签)
                查看流水链接- [ 查看明细 ]
                (无操作按钮)
        - 区域五：历史预约与消费
            - (一个可滚动的列表或时间线)
            - 记录1- 10月15日 - 经典剪发 - 已完成 - 核销次卡 (经典剪发次卡 #...)
            - 记录2- 10月10日 - 皮肤护理 - 未到店
            - 记录3- 10月01日 - 经典剪发 - 已完成 - 现金 ¥88
            - 记录4- 09月20日 - 皮肤护理 - 已完成 - 储值卡抵扣 (储值卡 #...) - ¥388
    -   功能逻辑
        - 页面加载时需聚合该会员所有关联数据。
        - 持有卡券展示:
            - 列表需清晰展示每张卡券的名称、余额/剩余次数、有效期截止日期以及当前的状态（有效、已用尽、已过期、已冻结）。
            - 不同状态的卡券应有明显的视觉区分（例如通过标签颜色）。
            - 只有状态为“有效”的储值卡才显示`[ 充值 ]`按钮。        
            - 每张卡券卡片下方需提供一个 [ 查看明细 ] 的链接或按钮。点击后，应弹出一个新的模态框或跳转到一个新页面，专门展示与该卡券实例相关的所有流水记录 (LedgerEntry)，按时间倒序排列，包含变动类型（购买/充值/消费/过期）、变动值、变动后余额/次数、关联交易单号（若有）等信息。
        - 解除绑定流程:
            - 当管理员或运营人员点击 `[ 解除绑定 ]` 链接时，系统弹出一个二次确认模态框。
            - 确认框内容：“您确定要解除该会员与微信‘[微信昵称]’的绑定吗？解除后，该会员将无法通过微信接收通知，也无法在小程序中看到此会员账户下的卡券信息。此操作不可逆，请谨慎确认。”
            - 用户点击“确认解除”后，系统将该`会员`记录中的`关联顾客ID`字段置为`null`。
            - 页面刷新，“微信绑定”信息消失。        
        - 历史记录展示:
            - 需清晰展示每一次预约或交易的日期、服务项目（若有）、最终状态（已完成/未到店/已取消等）。
            - 对于状态为“已完成”且产生了交易的记录，必须明确展示支付方式。
            - 如果支付方式为卡券（次卡核销/储值卡抵扣），则必须在支付方式后追加展示所使用的具体卡券实例信息（例如，卡券名称或卡券编号），以便追溯。        
        - 点击基础信息的[编辑]按钮，弹出“编辑会员信息”模态框。
        - 点击[办理新卡]按钮，弹出“办理新卡”模态框。
        - 点击储值卡上的[充值]按钮，弹出“卡券充值”模态框。

-   组件三- 手动录入 / 编辑会员 (模态框)
    -   页面布局
        - 标题- 录入新会员 / 编辑会员信息。
        - 表单- 姓名 (必填), 手机号 (必填), 会员备注 (选填, 多行文本)。
    -   功能逻辑
        - 编辑场景区分:
            - 编辑活跃会员时，“手机号”允许被修改。
            - 编辑已归档会员时，“手机号”也允许被修改，以便管理员在恢复前解决潜在的手机号冲突。
        - 保存时校验:
            - 手机号唯一性 (适用于新增和编辑): 在点击`[ 保存 ]`时，系统必须校验输入的手机号在所有“活跃”会员中是否唯一 (允许保存为自己原来的手机号)。
            - 新增场景: 如果手机号已存在于某个活跃会员档案中，则提示：“操作失败。该手机号已被其他会员占用，请核实。”
            - 编辑场景 (活跃或已归档): 如果试图将会员的手机号修改为另一个已存在的活跃会员的手机号，同样提示：“操作失败。该手机号已被其他会员占用，请核实。”
        - 字段必填: 姓名和手机号为必填项，不能为空。

-   组件四- 批量导入会员 (模态框与后续反馈)
    -   页面布局 (模态框)
        - 模态框标题- 批量导入会员
        - 步骤一：下载并填写模板
            - 说明- 请先下载我们的标准模板，并严格按照格式填写您的会员数据。模板包含“姓名”（必填）、“手机号”（必填）和“备注”（选填）三列。
            - 按钮- [ 下载标准模板.xlsx ]
        - 步骤二：上传文件
            - 说明- 准备好文件后，请点击此处上传（支持 .xls, .xlsx 格式）。
            - 上传区域- [ 点击或拖拽文件到此处 ]
        - 步骤三：校验与导入
            - (上传文件后的状态)
            - 校验结果- 校验通过！共发现 200 条数据，其中 5 条手机号重复，2 条手机号格式错误，将自动跳过。
            - 按钮- [ 重新上传 ]
            - 主按钮- [ 确认导入 193 条数据 ]
    -   功能逻辑 (导入过程与结果反馈)
        - 异步处理: 点击`[ 确认导入 ]`后，模态框关闭，系统在后台异步执行导入任务。页面顶部应出现一个短暂的提示：“会员导入任务已开始，请稍后查看结果。”
        - 任务完成通知:
            - 当后台导入任务完成时（无论成功、部分成功或失败），系统应在后台主界面的右上角（例如，靠近个人头像或通知中心图标处）显示一个红点或数字标记，提示用户有新的通知。
            - 用户点击该通知标记后，可以看到一条消息，例如：“会员批量导入完成！成功 193 条，失败 7 条。 [点击查看报告]”。
        - 导入历史与报告访问:
            - 在“会员管理”页面的 `[ ... ]` 更多操作菜单中，应增加一个“导入历史”选项。
            - 点击“导入历史”，会弹出一个新的模态框或跳转到新页面，展示历次批量导入的记录列表（包含：导入时间、操作人、上传文件名、状态、成功数、失败数、报告下载链接）。
            - 用户可以随时通过此入口找到并下载历史导入任务的详细导入报告（Excel格式，包含每行数据的导入状态及失败原因）。
        - 模板包含“姓名”（必填）、“手机号”（必填）、“备注”（选填）。
        - 后台导入时需进行数据校验（格式、必填项、手机号唯一性）。
        - 导入报告需包含每一行数据的导入状态（成功/失败）及失败原因。

-   组件五- 归档/恢复会员 (确认模态框)
    -   页面布局
        - 清晰的标题、提示信息、辅助说明。
        -   归档确认
            - 模态框标题- 确认归档
            - 提示图标- [ 警告图标 ]
            - 说明文字- 您确定要归档“李女士”吗？
            - 辅助说明- 归档后，该会员将从默认列表和搜索结果中隐藏，其历史记录将被保留。
            - 卡券处理警告 (如果该会员持有未用尽且未过期的卡券)- 请注意：该会员持有的有效卡券将被暂时冻结，在归档期间无法使用。
            - 条件警告 (如果该会员有未来预约)- 请注意：该会员名下仍有未完成的未来预约，归档并不会取消这些预约。
            - 底部操作栏- [ 取消 ] [ 确认归档 ]
        -   恢复确认
            - 模态框标题- 确认恢复
            - 说明文字- 您确定要恢复会员“张三”吗？
            - 辅助说明- 恢复后，该会员将重新出现在活跃会员列表和搜索结果中，其冻结的有效卡券将自动解冻。
            - 底部操作栏- [ 取消 ] [ 确认恢复 ]  
    -   功能逻辑
        - 用户确认归档后，系统执行状态变更，并根据下文“核心业务规则”处理其持有的卡券。
        - 用户确认恢复后，系统执行状态变更，并根据下文“核心业务规则”处理其持有的卡券。

-   组件六- 办理新卡 (模态框)
    -   页面布局
        - 选择卡券模板 (下拉菜单)。
        - 显示售价。
        - 输入实收金额。
        - 选择支付方式。
    -   功能逻辑
        - 若无可选卡券模板，需提示用户先去创建。
        - 点击确认后执行原子操作：
            - 创建`卡券实例`：根据所选`卡券模板`的规则（例如“购买后365天有效”或“固定日期2026-12-31前有效”）计算并设置该实例的`expiry_date`（过期时间），并将初始`status`设置为“有效”。
            - 创建`交易单`。
            - 创建`卡券流水`。

-   组件七- 卡券充值 (模态框)
    -   页面布局
        - 显示会员及当前卡券余额。
        - 输入充值金额。
        - 输入实收金额。
        - 选择支付方式。
    -   功能逻辑
        - 仅适用于状态为“有效”的储值卡。
        - 充值不改变卡券的原有有效期。
        - 点击确认后执行原子操作：更新`卡券实例`余额、创建`交易单`、创建`卡券流水`。

#### 核心业务规则

-   数据关联规则
    - 自动建档: 线上预约的新顾客，系统自动创建`会员`记录，并关联对应的`顾客`身份。此类会员初始无手机号。
    - 补充手机号关联: 当为无手机号的会员首次添加手机号时，系统应尝试在`顾客`库中查找是否有仅以此手机号存在的记录，若有则自动关联。
    - 修改手机号不变更关联: 修改会员已有手机号时，不自动变更其与`顾客`的关联。
    - 微信绑定优先: 已通过微信绑定的`会员`与`顾客`关系，不受手机号变更影响。
    - 手动解除绑定: 商户管理员和运营人员可以在会员详情页手动解除`会员`与`顾客`的绑定关系。此操作仅清空`会员`记录中的`关联顾客ID`，不会删除`顾客`记录本身。解除绑定后，该会员将失去所有与微信身份相关的功能（如接收通知、小程序查看资产等）。

-   数据完整性规则
    - 手机号唯一性: 在所有“活跃”会员中，手机号必须是唯一的。
    - 恢复冲突处理: 在恢复一个已归档会员前，系统必须校验其手机号是否与当前任何活跃会员冲突。若冲突，必须阻止恢复并提示用户先解决冲突（例如，通过编辑已归档会员的手机号）。
    - 归档会员的卡券处理:
        - 冻结: 当一个会员被归档时，其名下所有未过期且未用尽的`卡券实例`状态应自动变更为“已冻结”。
        - 不可用: 处于“已冻结”状态的卡券，在任何业务场景（如预约结算）中都不可被选用或核销。
        - 有效期: 卡券的有效期在冻结期间仍然会正常计算。如果卡券在会员归档期间自然过期，即使会员后续被恢复，该卡券也将保持“已过期”状态。
        - 恢复: 当一个会员被恢复为“活跃”状态时，系统应自动将其名下所有处于“已冻结”状态且尚未过期的`卡券实例`状态恢复为“有效”。
    -   卡券状态与有效期规则
        - 状态定义: `卡券实例 (CardInstance)` 必须包含一个`status`字段，其核心状态至少包括：
            - `有效 (Active)`: 卡券在有效期内且有剩余次数/余额。
            - `已用尽 (Depleted)`: 卡券剩余次数/余额为0。
            - `已过期 (Expired)`: 当前日期已超过卡券的`expiry_date`。
            - `已冻结 (Frozen)`: 因会员被归档而暂时停用。
        - 有效期计算:
            - `卡券模板 (CardTemplate)` 需定义有效期规则（例如：固定日期、购买后N天/月/年）。
            - 在创建`卡券实例`时（办理新卡），系统必须根据模板规则计算出具体的`expiry_date`并存储。
        - 状态流转:
            - 新卡办理后，状态为`有效`。
            - 当余额/次数消耗至0时，状态变为`已用尽`。
            - 当当前日期超过`expiry_date`时，状态变为`已过期`（系统需有定时任务或在查询时判断）。
            - 会员被归档时，状态为`有效`的卡券变为`已冻结`。
            - 会员被恢复时，状态为`已冻结`且尚未过期的卡券恢复为`有效`。
        - 业务可用性: 只有状态为`有效`的卡券才能被用于预约结算核销或进行充值。        
#### 成功指标

-   数据迁移效率- 提供批量导入功能后，新启用商家在首周内导入的存量会员平均数 > 50。
-   会员纳管率- （系统内会员总数 / 商家预估活跃会员数） > 80%。
-   卡券渗透率- （持有有效卡券的会员数 / 活跃会员总数） > 20%，表明增长引擎被有效利用。
-   操作效率- 用户完成“为一位老会员办理一张新储值卡”的平均操作时长 < 1分钟。
